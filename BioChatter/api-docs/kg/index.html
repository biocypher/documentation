
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://biocypher.org/BioChatter/api-docs/kg/">
      
      
        <link rel="prev" href="../vectorstore/">
      
      
        <link rel="next" href="../api-calling-base/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.5">
    
    
      
        <title>Knowledge Graph Agent - The BioCypher Ecosystem</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../assets/css/css-v1.1.0.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Knowledge Graph Agent - The BioCypher Ecosystem" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="https://biocypher.org/assets/images/social/BioChatter/api-docs/kg.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://biocypher.org/BioChatter/api-docs/kg/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Knowledge Graph Agent - The BioCypher Ecosystem" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="https://biocypher.org/assets/images/social/BioChatter/api-docs/kg.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#knowledge-graph-agent-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="The BioCypher Ecosystem" class="md-header__button md-logo" aria-label="The BioCypher Ecosystem" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The BioCypher Ecosystem
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Knowledge Graph Agent
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/biocypher/biocypher" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    biocypher/biocypher
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  About

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../BioCypher/" class="md-tabs__link">
          
  
  BioCypher

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  BioChatter

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The BioCypher Ecosystem" class="md-nav__button md-logo" aria-label="The BioCypher Ecosystem" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The BioCypher Ecosystem
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/biocypher/biocypher" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    biocypher/biocypher
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/publications.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Publications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/timeline.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Timeline
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/sponsors.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sponsors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_5" >
        
          
          <label class="md-nav__link" for="__nav_1_5" id="__nav_1_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Community
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1_5">
            <span class="md-nav__icon md-icon"></span>
            Community
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/community/index.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/community/contribute.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute to BioCypher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/community/contribute-docs.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute to the Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../biocypher/docs/community/contribute-codebase.md" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute to the Code Base
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    BioCypher
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            BioCypher
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/biocypher-project/project/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/biocypher-project/design-philosophy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design philosophy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/biocypher-project/publications/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Publications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/biocypher-project/use-cases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Use Cases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/biocypher-project/biochatter-integration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BioCypher + LLMs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/biocypher-project/sponsors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sponsors
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Get Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Get Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/quickstart/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Learn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Learn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/tutorials/tutorial001_basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basics
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/tutorials/tutorial002_handling_ontologies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Handling Ontologies
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/tutorials/tutorial003_adapters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/tutorials/pandas_tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example Notebook: BioCypher and Pandas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_5" >
        
          
          <label class="md-nav__link" for="__nav_2_4_5" id="__nav_2_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_5">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_6" >
        
          
          <label class="md-nav__link" for="__nav_2_4_6" id="__nav_2_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Explanation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_6">
            <span class="md-nav__icon md-icon"></span>
            Explanation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/explanation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation:
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/guides/adapters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/learn/guides/ontologies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ontologies
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reference Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_2" >
        
          
          <label class="md-nav__link" for="__nav_2_5_2" id="__nav_2_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_2">
            <span class="md-nav__icon md-icon"></span>
            API Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/source/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BioCypher
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/biocypher-config-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BioCypher Configuration Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_4" >
        
          
          <label class="md-nav__link" for="__nav_2_5_4" id="__nav_2_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Outputs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_4">
            <span class="md-nav__icon md-icon"></span>
            Outputs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/arangodb-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ArangoDB
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/neo4j-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neo4j
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/networkx-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NetworkX
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/postgresql-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PostgreSQL
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/rdf-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RDF
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/sqlite-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SQLite
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/outputs/tabular-output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tabular Format
    
  </span>
  
    
  
  
    <span class="md-status md-status--old"></span>
  

  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/reference/schema-config-guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Schema Configuration Reference
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Community
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Community
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/community/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Join Us
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/community/contribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Where to Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/community/contribute-docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute to the Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BioCypher/community/contribute-codebase/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contribute to the Code Base
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    BioChatter
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            BioChatter
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/chat/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic Usage - Chat
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/rag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Retrieval-Augmented Generation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Calling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/reflexion-agent/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reflexion via LangGraph
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/open-llm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Open-source and Local LLMs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/wasm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLM in your Browser - WebAssembly
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/benchmark/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The Living Benchmark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/podcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Podcast my Paper
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Benchmark
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Benchmark
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmark/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmark/results/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    All Results
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../benchmark/developer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Vignettes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Vignettes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vignettes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vignettes/kg/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Knowledge Graph RAG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vignettes/rag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Retrieval-Augmented Generation (RAG)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vignettes/custom-bclight-simple/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customising BioChatter Light - Simple
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vignettes/custom-bclight-advanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customising BioChatter Light - Advanced
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../vignettes/custom-decider-use-case/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customising BioChatter Light and Next - Cancer Genetics Use Case
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" checked>
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm_connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLM Connectivity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../vectorstore/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vectorstore Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Knowledge Graph Agent
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Knowledge Graph Agent
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dynamic-prompt-generation-for-biocypher-knowledge-graphs" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic prompt generation for BioCypher knowledge graphs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#biochatter.prompts" class="md-nav__link">
    <span class="md-ellipsis">
      prompts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine" class="md-nav__link">
    <span class="md-ellipsis">
      BioCypherPromptEngine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BioCypherPromptEngine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._capitalise_source_and_target" class="md-nav__link">
    <span class="md-ellipsis">
      _capitalise_source_and_target
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._generate_query" class="md-nav__link">
    <span class="md-ellipsis">
      _generate_query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._generate_query_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      _generate_query_prompt
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._get_conversation" class="md-nav__link">
    <span class="md-ellipsis">
      _get_conversation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._select_entities" class="md-nav__link">
    <span class="md-ellipsis">
      _select_entities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._select_properties" class="md-nav__link">
    <span class="md-ellipsis">
      _select_properties
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine._select_relationships" class="md-nav__link">
    <span class="md-ellipsis">
      _select_relationships
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine.generate_query" class="md-nav__link">
    <span class="md-ellipsis">
      generate_query
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.prompts.BioCypherPromptEngine.generate_query_prompt" class="md-nav__link">
    <span class="md-ellipsis">
      generate_query_prompt
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#execution-of-prompts-against-the-database" class="md-nav__link">
    <span class="md-ellipsis">
      Execution of prompts against the database
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#biochatter.database_agent" class="md-nav__link">
    <span class="md-ellipsis">
      database_agent
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#biochatter.database_agent.DatabaseAgent" class="md-nav__link">
    <span class="md-ellipsis">
      DatabaseAgent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DatabaseAgent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#biochatter.database_agent.DatabaseAgent.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.database_agent.DatabaseAgent.connect" class="md-nav__link">
    <span class="md-ellipsis">
      connect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#biochatter.database_agent.DatabaseAgent.get_query_results" class="md-nav__link">
    <span class="md-ellipsis">
      get_query_results
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-calling-base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Calling: Base Classes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-calling-web/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Calling: Web APIs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-calling-python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API Calling: Python APIs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../reflexion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reflexion Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../podcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Podcast
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/biocypher/biocypher/edit/master/biochatter/docs/api-docs/kg.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="knowledge-graph-agent-reference">Knowledge Graph Agent Reference</h1>
<p>Here we handle generation of use case-specific database prompts and their
execution against a database using the database agent.</p>
<h2 id="dynamic-prompt-generation-for-biocypher-knowledge-graphs">Dynamic prompt generation for BioCypher knowledge graphs</h2>


<div class="doc doc-object doc-module">



<a id="biochatter.prompts"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="biochatter.prompts.BioCypherPromptEngine" class="doc doc-heading">
            <code>BioCypherPromptEngine</code>


</h2>


    <div class="doc doc-contents ">







              <details class="quote">
                <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">BioCypherPromptEngine</span><span class="p">:</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="n">schema_config_or_info_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">schema_config_or_info_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">conversation_factory</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a biocypher schema configuration, extract the entities and</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        relationships, and for each extract their mode of representation (node</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        or edge), properties, and identifier namespace. Using these data, allow</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        the generation of prompts for a large language model, informing it of</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        the schema constituents and their properties, to enable the</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        parameterisation of function calls to a knowledge graph.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        ----</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            schema_config_or_info_path: Path to a biocypher schema configuration</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">                file or the extended schema information output generated by</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">                BioCypher&#39;s `write_schema_info` function (preferred).</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            schema_config_or_info_dict: A dictionary containing the schema</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">                configuration file or the extended schema information output</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">                generated by BioCypher&#39;s `write_schema_info` function</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">                (preferred).</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            model_name: The name of the model to use for the conversation.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">                DEPRECATED: This should now be set in the conversation factory.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">            conversation_factory: A function used to create a conversation for</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">                creating the KG query. If not provided, a default function is</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">                used (creating an OpenAI conversation with the specified model,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">                see `_get_conversation`).</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema_config_or_info_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">schema_config_or_info_dict</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>                <span class="s2">&quot;Please provide the schema configuration or schema info as a path to a file or as a dictionary.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="k">if</span> <span class="n">schema_config_or_info_path</span> <span class="ow">and</span> <span class="n">schema_config_or_info_dict</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="s2">&quot;Please provide the schema configuration or schema info as a &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="s2">&quot;path to a file or as a dictionary, not both.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="c1"># set conversation factory or use default</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span> <span class="o">=</span> <span class="n">conversation_factory</span> <span class="k">if</span> <span class="n">conversation_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_conversation</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">if</span> <span class="n">schema_config_or_info_path</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="c1"># read the schema configuration</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_config_or_info_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="n">schema_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="k">elif</span> <span class="n">schema_config_or_info_dict</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="n">schema_config</span> <span class="o">=</span> <span class="n">schema_config_or_info_dict</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="c1"># check whether it is the original schema config or the output of</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="c1"># biocypher info</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">is_schema_info</span> <span class="o">=</span> <span class="n">schema_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_schema_info&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="c1"># extract the entities and relationships: each top level key that has</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="c1"># a &#39;represented_as&#39; key</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_schema_info</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                <span class="c1"># hacky, better with biocypher output</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="n">name_indicates_relationship</span> <span class="o">=</span> <span class="s2">&quot;interaction&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;association&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="k">if</span> <span class="s2">&quot;represented_as&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                    <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;represented_as&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name_indicates_relationship</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                    <span class="k">elif</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;represented_as&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span> <span class="ow">and</span> <span class="n">name_indicates_relationship</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                        <span class="s2">&quot;represented_as&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                    <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;edge&quot;</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;present_in_knowledge_graph&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_relationship&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_relationship&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capitalise_source_and_target</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># used in property selection</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># copy to deal with labels that</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="c1"># are not the same as the relationship name, used in query generation</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="c1"># dictionary to also include source and target types</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_capitalise_source_and_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationship</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Make sources and targets PascalCase to match the entities. Sources and</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">        targets can be strings or lists of strings.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">if</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">return</span> <span class="n">relationship</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_graph_entities_from_question</span><span class="p">(</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">conversation</span><span class="p">:</span> <span class="n">Conversation</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">success1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_entities</span><span class="p">(</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">conversation</span><span class="o">=</span><span class="n">conversation</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="p">)</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">success1</span><span class="p">:</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="s2">&quot;Entity selection failed. Please try again with a different question.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="n">success2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_relationships</span><span class="p">(</span><span class="n">conversation</span><span class="o">=</span><span class="n">conversation</span><span class="p">)</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">success2</span><span class="p">:</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="s2">&quot;Relationship selection failed. Please try again with a different question.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">success3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_properties</span><span class="p">(</span><span class="n">conversation</span><span class="o">=</span><span class="n">conversation</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">success3</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="s2">&quot;Property selection failed. Please try again with a different question.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">relationships</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Cypher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a prompt for a large language model to generate a database</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        query based on the selected entities, relationships, and properties.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        ----</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">            entities: A list of entities that are relevant to the question.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">            relationships: A list of relationships that are relevant to the</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">                question.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            properties: A dictionary of properties that are relevant to the</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">                question.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">            query_language: The language of the query to generate.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">        -------</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">            A prompt for a large language model to generate a database query.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>            <span class="sa">f</span><span class="s2">&quot;Generate a database query in </span><span class="si">{</span><span class="n">query_language</span><span class="si">}</span><span class="s2"> that answers &quot;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="sa">f</span><span class="s2">&quot;the user&#39;s question. &quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="sa">f</span><span class="s2">&quot;You can use the following entities: </span><span class="si">{</span><span class="n">entities</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="sa">f</span><span class="s2">&quot;relationships: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">relationships</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">, and &quot;</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="sa">f</span><span class="s2">&quot;properties: </span><span class="si">{</span><span class="n">properties</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">for</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">relationships</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_expand_pairs</span><span class="p">(</span><span class="n">relationship</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Given the following valid combinations of source, relationship, and target: &quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;(:</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)-(:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">)-&gt;(:</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&#39;, &quot;</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;generate a </span><span class="si">{</span><span class="n">query_language</span><span class="si">}</span><span class="s2"> query using one of these combinations. &quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Only return the query, without any additional text, symbols or characters --- just the query statement.&quot;</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Cypher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a prompt for a large language model to generate a database</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">        query based on the user&#39;s question and class attributes informing about</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        the schema.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        ----</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">            question: A user&#39;s question.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">            query_language: The language of the query to generate.</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        -------</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">            A prompt for a large language model to generate a database query.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_select_graph_entities_from_question</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">(),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="n">query_language</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">return</span> <span class="n">msg</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_query</span><span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Cypher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrap entity and property selection and query generation; return the</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">        generated query.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">        ----</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">            question: A user&#39;s question.</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">            query_language: The language of the query to generate.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        -------</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">            A database query that could answer the user&#39;s question.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_select_graph_entities_from_question</span><span class="p">(</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">(),</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query</span><span class="p">(</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">entities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="n">relationships</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="n">properties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">query_language</span><span class="o">=</span><span class="n">query_language</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">conversation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">(),</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_conversation</span><span class="p">(</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a conversation object given a model name.</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">        ----</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">            model_name: The name of the model to use for the conversation.</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">        -------</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">            A BioChatter Conversation object for connecting to the LLM.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">        Todo:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">        ----</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">            Genericise to models outside of OpenAI.</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">conversation</span> <span class="o">=</span> <span class="n">GptConversation</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="n">prompts</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">correct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">set_api_key</span><span class="p">(</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">),</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">user</span><span class="o">=</span><span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">return</span> <span class="n">conversation</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_entities</span><span class="p">(</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a question, select the entities that are relevant to the question</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        and store them in `selected_entities` and `selected_relationships`. Use</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        LLM conversation to do this.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">        ----</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">            question: A user&#39;s question.</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">            conversation: A BioChatter Conversation object for connecting to the</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">                LLM.</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">        -------</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">            True if at least one entity was selected, False otherwise.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">question</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="s2">&quot;You have access to a knowledge graph that contains &quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="sa">f</span><span class="s2">&quot;these entity types: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2">. Your task is &quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="s2">&quot;to select the entity types that are relevant to the user&#39;s question &quot;</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="s2">&quot;for subsequent use in a query. Only return the entity types, &quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="s2">&quot;comma-separated, without any additional text. Do not return &quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="s2">&quot;entity names, relationships, or properties.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">msg</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="c1"># TODO: do we go back and retry if no entities were selected? or ask for</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="c1"># a reason? offer visual selection of entities and relationships by the</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="c1"># user?</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                <span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a question and the preselected entities, select relationships for</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">        the query.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">        ----</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">            conversation: A BioChatter Conversation object for connecting to the</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">                LLM.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">        -------</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">            True if at least one relationship was selected, False otherwise.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">        Todo:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">        ----</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">            Now we have the problem that we discard all relationships that do</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">            not have a source and target, if at least one relationship has a</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">            source and target. At least communicate this all-or-nothing</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">            behaviour to the user.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>                <span class="s2">&quot;No question found. Please make sure to run entity selection first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>                <span class="s2">&quot;No entities found. Please run the entity selection step first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">rels</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="n">source_and_target_present</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="c1"># if source or target is a list, expand to single pairs</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                <span class="n">source</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                            <span class="p">(</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                                <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                                <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                            <span class="p">),</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                        <span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="n">rels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairs</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="n">source_and_target_present</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                <span class="n">rels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="c1"># prioritise relationships that have source and target, and discard</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="c1"># relationships that do not have both source and target, if at least one</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="c1"># relationship has both source and target. keep relationships that have</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="c1"># either source or target, if none of the relationships have both source</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="c1"># and target.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="k">if</span> <span class="n">source_and_target_present</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="c1"># First, separate the relationships into two groups: those with both</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>            <span class="c1"># source and target in the selected entities, and those with either</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="c1"># source or target but not both.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="n">rels_with_both</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>            <span class="n">rels_with_either</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                    <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                        <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                            <span class="n">rels_with_both</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                            <span class="n">rels_with_either</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                    <span class="k">elif</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                        <span class="n">rels_with_either</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="c1"># If there are any relationships with both source and target,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="c1"># discard the others.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="k">if</span> <span class="n">rels_with_both</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="n">rels</span> <span class="o">=</span> <span class="n">rels_with_both</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="n">rels</span> <span class="o">=</span> <span class="n">rels_with_either</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="n">selected_rels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                    <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span> <span class="ow">or</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                        <span class="n">selected_rels</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">pair</span><span class="p">))</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="n">rels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selected_rels</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>            <span class="n">rels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="s2">&quot;You have access to a knowledge graph that contains &quot;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="sa">f</span><span class="s2">&quot;these entities: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="s2">&quot;Your task is to select the relationships that are relevant &quot;</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="s2">&quot;to the user&#39;s question for subsequent use in a query. Only &quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="s2">&quot;return the relationships without their sources or targets, &quot;</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="s2">&quot;comma-separated, and without any additional text. Here are the &quot;</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="s2">&quot;possible relationships and their source and target entities: &quot;</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rels</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">res</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="n">relationship</span> <span class="o">=</span> <span class="n">relationship</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                <span class="k">if</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                    <span class="n">rel_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                    <span class="n">label</span> <span class="o">=</span> <span class="n">rel_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_as_edge&quot;</span><span class="p">,</span> <span class="n">relationship</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                    <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">rel_dict</span> <span class="ow">and</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">rel_dict</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">rel_dict</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">rel_dict</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                        <span class="p">}</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                            <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                        <span class="p">}</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="c1"># if we selected relationships that have either source or target which</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="c1"># is not in the selected entities, we add those entities to the selected</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="c1"># entities.</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">:</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                <span class="n">sources</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                <span class="n">targets</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>                    <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                            <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">source</span><span class="p">),</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                        <span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                        <span class="k">continue</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                    <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                            <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                        <span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_json_str</span><span class="p">(</span><span class="n">json_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="k">if</span> <span class="n">json_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;```json&quot;</span><span class="p">):</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>            <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="k">if</span> <span class="n">json_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">):</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>            <span class="n">json_str</span> <span class="o">=</span> <span class="n">json_str</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="k">return</span> <span class="n">json_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Given a question (optionally provided, but in the standard use case</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">        reused from the entity selection step) and the selected entities, select</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">        the properties that are relevant to the question and store them in</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">        the dictionary `selected_properties`.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">        -------</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="sd">            True if at least one property was selected, False otherwise.</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="s2">&quot;No question found. Please make sure to run entity and relationship selection first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>            <span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                <span class="s2">&quot;No entities or relationships provided, and none available &quot;</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>                <span class="s2">&quot;from entity selection step. Please provide &quot;</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                <span class="s2">&quot;entities/relationships or run the entity selection &quot;</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                <span class="s2">&quot;(`select_entities()`) step first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="n">e_props</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">):</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>                <span class="n">e_props</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity</span><span class="p">][</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>                <span class="p">)</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="n">r_props</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span><span class="p">:</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">):</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>                <span class="n">r_props</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">relationship</span><span class="p">][</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>                <span class="p">)</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>            <span class="s2">&quot;You have access to a knowledge graph that contains entities and &quot;</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>            <span class="s2">&quot;relationships. They have the following properties. Entities:&quot;</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e_props</span><span class="si">}</span><span class="s2">, Relationships: </span><span class="si">{</span><span class="n">r_props</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>            <span class="s2">&quot;Your task is to select the properties that are relevant to the &quot;</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>            <span class="s2">&quot;user&#39;s question for subsequent use in a query. Only return the &quot;</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>            <span class="s2">&quot;entities and relationships with their relevant properties in compact &quot;</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>            <span class="s2">&quot;JSON format, without any additional text. Return the &quot;</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>            <span class="s2">&quot;entities/relationships as top-level dictionary keys, and their &quot;</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="s2">&quot;properties as dictionary values. &quot;</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>            <span class="s2">&quot;Do not return properties that are not relevant to the question.&quot;</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>        <span class="p">)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">msg</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">BioCypherPromptEngine</span><span class="o">.</span><span class="n">_validate_json_str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span><span class="p">)</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_query</span><span class="p">(</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>        <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="n">relationships</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>        <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>        <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a query in the specified query language that answers the user&#39;s</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="sd">        question.</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">        ----</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">            question: A user&#39;s question.</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">            entities: A list of entities that are relevant to the question.</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">            relationships: A list of relationships that are relevant to the</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">                question.</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">            properties: A dictionary of properties that are relevant to the</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">                question.</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">            query_language: The language of the query to generate.</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">            conversation: A BioChatter Conversation object for connecting to the</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">                LLM.</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">        -------</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">            A database query that could answer the user&#39;s question.</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>            <span class="n">entities</span><span class="p">,</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="n">relationships</span><span class="p">,</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>            <span class="n">properties</span><span class="p">,</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="n">query_language</span><span class="p">,</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>        <span class="p">)</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>        <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="n">out_msg</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="k">return</span> <span class="n">out_msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_expand_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relationship</span><span class="p">):</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>                    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                            <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">),</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                        <span class="p">)</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                        <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>                    <span class="p">)</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]:</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>                    <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">target</span><span class="p">),</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>                <span class="p">)</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>                <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]),</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">schema_config_or_info_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">schema_config_or_info_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="s1">&#39;gpt-3.5-turbo&#39;</span><span class="p">,</span> <span class="n">conversation_factory</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Given a biocypher schema configuration, extract the entities and
relationships, and for each extract their mode of representation (node
or edge), properties, and identifier namespace. Using these data, allow
the generation of prompts for a large language model, informing it of
the schema constituents and their properties, to enable the
parameterisation of function calls to a knowledge graph.</p>
        <hr />
<div class="highlight"><pre><span></span><code>schema_config_or_info_path: Path to a biocypher schema configuration
    file or the extended schema information output generated by
    BioCypher&#39;s `write_schema_info` function (preferred).

schema_config_or_info_dict: A dictionary containing the schema
    configuration file or the extended schema information output
    generated by BioCypher&#39;s `write_schema_info` function
    (preferred).

model_name: The name of the model to use for the conversation.
    DEPRECATED: This should now be set in the conversation factory.

conversation_factory: A function used to create a conversation for
    creating the KG query. If not provided, a default function is
    used (creating an OpenAI conversation with the specified model,
    see `_get_conversation`).
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="n">schema_config_or_info_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">schema_config_or_info_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">conversation_factory</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a biocypher schema configuration, extract the entities and</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    relationships, and for each extract their mode of representation (node</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    or edge), properties, and identifier namespace. Using these data, allow</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    the generation of prompts for a large language model, informing it of</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    the schema constituents and their properties, to enable the</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    parameterisation of function calls to a knowledge graph.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    ----</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        schema_config_or_info_path: Path to a biocypher schema configuration</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">            file or the extended schema information output generated by</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            BioCypher&#39;s `write_schema_info` function (preferred).</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        schema_config_or_info_dict: A dictionary containing the schema</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            configuration file or the extended schema information output</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            generated by BioCypher&#39;s `write_schema_info` function</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">            (preferred).</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        model_name: The name of the model to use for the conversation.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            DEPRECATED: This should now be set in the conversation factory.</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        conversation_factory: A function used to create a conversation for</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">            creating the KG query. If not provided, a default function is</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">            used (creating an OpenAI conversation with the specified model,</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            see `_get_conversation`).</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">schema_config_or_info_path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">schema_config_or_info_dict</span><span class="p">:</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="s2">&quot;Please provide the schema configuration or schema info as a path to a file or as a dictionary.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="k">if</span> <span class="n">schema_config_or_info_path</span> <span class="ow">and</span> <span class="n">schema_config_or_info_dict</span><span class="p">:</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="s2">&quot;Please provide the schema configuration or schema info as a &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="s2">&quot;path to a file or as a dictionary, not both.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>    <span class="c1"># set conversation factory or use default</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span> <span class="o">=</span> <span class="n">conversation_factory</span> <span class="k">if</span> <span class="n">conversation_factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_conversation</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">if</span> <span class="n">schema_config_or_info_path</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="c1"># read the schema configuration</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_config_or_info_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="n">schema_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">elif</span> <span class="n">schema_config_or_info_dict</span><span class="p">:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="n">schema_config</span> <span class="o">=</span> <span class="n">schema_config_or_info_dict</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>    <span class="c1"># check whether it is the original schema config or the output of</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="c1"># biocypher info</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="n">is_schema_info</span> <span class="o">=</span> <span class="n">schema_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_schema_info&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="c1"># extract the entities and relationships: each top level key that has</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>    <span class="c1"># a &#39;represented_as&#39; key</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">entities</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_schema_info</span><span class="p">:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="c1"># hacky, better with biocypher output</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">name_indicates_relationship</span> <span class="o">=</span> <span class="s2">&quot;interaction&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;association&quot;</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="k">if</span> <span class="s2">&quot;represented_as&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;represented_as&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name_indicates_relationship</span><span class="p">:</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>                <span class="k">elif</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;represented_as&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;node&quot;</span> <span class="ow">and</span> <span class="n">name_indicates_relationship</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span><span class="p">[</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                    <span class="s2">&quot;represented_as&quot;</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;edge&quot;</span><span class="p">:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schema_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="k">continue</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;present_in_knowledge_graph&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="k">continue</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_relationship&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="k">elif</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_relationship&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capitalise_source_and_target</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># used in property selection</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># copy to deal with labels that</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="c1"># are not the same as the relationship name, used in query generation</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="c1"># dictionary to also include source and target types</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._capitalise_source_and_target" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_capitalise_source_and_target</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Make sources and targets PascalCase to match the entities. Sources and
targets can be strings or lists of strings.</p>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-107" name="__codelineno-0-107"></a><span class="k">def</span><span class="w"> </span><span class="nf">_capitalise_source_and_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relationship</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Make sources and targets PascalCase to match the entities. Sources and</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><span class="sd">    targets can be strings or lists of strings.</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>    <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">:</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">if</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">relationship</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">return</span> <span class="n">relationship</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._generate_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_generate_query</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">entities</span><span class="p">,</span> <span class="n">relationships</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">query_language</span><span class="p">,</span> <span class="n">conversation</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a query in the specified query language that answers the user's
question.</p>
        <hr />
<div class="highlight"><pre><span></span><code>question: A user&#39;s question.

entities: A list of entities that are relevant to the question.

relationships: A list of relationships that are relevant to the
    question.

properties: A dictionary of properties that are relevant to the
    question.

query_language: The language of the query to generate.

conversation: A BioChatter Conversation object for connecting to the
    LLM.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>A database query that could answer the user&#39;s question.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-572" name="__codelineno-0-572"></a><span class="k">def</span><span class="w"> </span><span class="nf">_generate_query</span><span class="p">(</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>    <span class="n">relationships</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a query in the specified query language that answers the user&#39;s</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a><span class="sd">    question.</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a><span class="sd">    ----</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="sd">        question: A user&#39;s question.</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">        entities: A list of entities that are relevant to the question.</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">        relationships: A list of relationships that are relevant to the</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">            question.</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a><span class="sd">        properties: A dictionary of properties that are relevant to the</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">            question.</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">        query_language: The language of the query to generate.</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a><span class="sd">        conversation: A BioChatter Conversation object for connecting to the</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a><span class="sd">            LLM.</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a><span class="sd">    -------</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a><span class="sd">        A database query that could answer the user&#39;s question.</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>        <span class="n">entities</span><span class="p">,</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>        <span class="n">relationships</span><span class="p">,</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="n">properties</span><span class="p">,</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>        <span class="n">query_language</span><span class="p">,</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>    <span class="p">)</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>    <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>    <span class="n">out_msg</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>    <span class="k">return</span> <span class="n">out_msg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._generate_query_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_generate_query_prompt</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">relationships</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">query_language</span><span class="o">=</span><span class="s1">&#39;Cypher&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a prompt for a large language model to generate a database
query based on the selected entities, relationships, and properties.</p>
        <hr />
<div class="highlight"><pre><span></span><code>entities: A list of entities that are relevant to the question.

relationships: A list of relationships that are relevant to the
    question.

properties: A dictionary of properties that are relevant to the
    question.

query_language: The language of the query to generate.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>A prompt for a large language model to generate a database query.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="k">def</span><span class="w"> </span><span class="nf">_generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>    <span class="n">relationships</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>    <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Cypher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a prompt for a large language model to generate a database</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    query based on the selected entities, relationships, and properties.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    ----</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        entities: A list of entities that are relevant to the question.</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        relationships: A list of relationships that are relevant to the</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            question.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        properties: A dictionary of properties that are relevant to the</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            question.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        query_language: The language of the query to generate.</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a><span class="sd">    -------</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a><span class="sd">        A prompt for a large language model to generate a database query.</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="sa">f</span><span class="s2">&quot;Generate a database query in </span><span class="si">{</span><span class="n">query_language</span><span class="si">}</span><span class="s2"> that answers &quot;</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="sa">f</span><span class="s2">&quot;the user&#39;s question. &quot;</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="sa">f</span><span class="s2">&quot;You can use the following entities: </span><span class="si">{</span><span class="n">entities</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="sa">f</span><span class="s2">&quot;relationships: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">relationships</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">, and &quot;</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="sa">f</span><span class="s2">&quot;properties: </span><span class="si">{</span><span class="n">properties</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="k">for</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">relationships</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_pairs</span><span class="p">(</span><span class="n">relationship</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="p">:</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Given the following valid combinations of source, relationship, and target: &quot;</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_directions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;(:</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)-(:</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">)-&gt;(:</span><span class="si">{</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&#39;, &quot;</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;generate a </span><span class="si">{</span><span class="n">query_language</span><span class="si">}</span><span class="s2"> query using one of these combinations. &quot;</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Only return the query, without any additional text, symbols or characters --- just the query statement.&quot;</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">return</span> <span class="n">msg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._get_conversation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_get_conversation</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a conversation object given a model name.</p>
        <hr />
<div class="highlight"><pre><span></span><code>model_name: The name of the model to use for the conversation.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>A BioChatter Conversation object for connecting to the LLM.
</code></pre></div>
<h5 id="biochatter.prompts.BioCypherPromptEngine._get_conversation--todo">Todo:</h5>
<div class="highlight"><pre><span></span><code>Genericise to models outside of OpenAI.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="k">def</span><span class="w"> </span><span class="nf">_get_conversation</span><span class="p">(</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a conversation object given a model name.</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">    ----</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a><span class="sd">        model_name: The name of the model to use for the conversation.</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a><span class="sd">    -------</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a><span class="sd">        A BioChatter Conversation object for connecting to the LLM.</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="sd">    Todo:</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="sd">    ----</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="sd">        Genericise to models outside of OpenAI.</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="n">conversation</span> <span class="o">=</span> <span class="n">GptConversation</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">prompts</span><span class="o">=</span><span class="p">{},</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">correct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="n">conversation</span><span class="o">.</span><span class="n">set_api_key</span><span class="p">(</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">),</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">user</span><span class="o">=</span><span class="s2">&quot;test_user&quot;</span><span class="p">,</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">return</span> <span class="n">conversation</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._select_entities" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_select_entities</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">conversation</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Given a question, select the entities that are relevant to the question
and store them in <code>selected_entities</code> and <code>selected_relationships</code>. Use
LLM conversation to do this.</p>
        <hr />
<div class="highlight"><pre><span></span><code>question: A user&#39;s question.

conversation: A BioChatter Conversation object for connecting to the
    LLM.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>True if at least one entity was selected, False otherwise.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="k">def</span><span class="w"> </span><span class="nf">_select_entities</span><span class="p">(</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a question, select the entities that are relevant to the question</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    and store them in `selected_entities` and `selected_relationships`. Use</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">    LLM conversation to do this.</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="sd">    ----</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="sd">        question: A user&#39;s question.</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        conversation: A BioChatter Conversation object for connecting to the</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">            LLM.</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a><span class="sd">    -------</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">        True if at least one entity was selected, False otherwise.</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">question</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>    <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="s2">&quot;You have access to a knowledge graph that contains &quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="sa">f</span><span class="s2">&quot;these entity types: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s2">. Your task is &quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="s2">&quot;to select the entity types that are relevant to the user&#39;s question &quot;</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="s2">&quot;for subsequent use in a query. Only return the entity types, &quot;</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="s2">&quot;comma-separated, without any additional text. Do not return &quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="s2">&quot;entity names, relationships, or properties.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="n">msg</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="c1"># TODO: do we go back and retry if no entities were selected? or ask for</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>    <span class="c1"># a reason? offer visual selection of entities and relationships by the</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="c1"># user?</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="k">if</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._select_properties" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_select_properties</span><span class="p">(</span><span class="n">conversation</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Given a question (optionally provided, but in the standard use case
reused from the entity selection step) and the selected entities, select
the properties that are relevant to the question and store them in
the dictionary <code>selected_properties</code>.</p>
<h5 id="biochatter.prompts.BioCypherPromptEngine._select_properties--returns">Returns</h5>
<div class="highlight"><pre><span></span><code>True if at least one property was selected, False otherwise.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="k">def</span><span class="w"> </span><span class="nf">_select_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a question (optionally provided, but in the standard use case</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">    reused from the entity selection step) and the selected entities, select</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a><span class="sd">    the properties that are relevant to the question and store them in</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a><span class="sd">    the dictionary `selected_properties`.</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a><span class="sd">    -------</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="sd">        True if at least one property was selected, False otherwise.</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>            <span class="s2">&quot;No question found. Please make sure to run entity and relationship selection first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>        <span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>            <span class="s2">&quot;No entities or relationships provided, and none available &quot;</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>            <span class="s2">&quot;from entity selection step. Please provide &quot;</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="s2">&quot;entities/relationships or run the entity selection &quot;</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="s2">&quot;(`select_entities()`) step first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>        <span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>    <span class="n">e_props</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">):</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="n">e_props</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity</span><span class="p">][</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>            <span class="p">)</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>    <span class="n">r_props</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>    <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span><span class="p">:</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">):</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>            <span class="n">r_props</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">relationship</span><span class="p">][</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="p">)</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>        <span class="s2">&quot;You have access to a knowledge graph that contains entities and &quot;</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>        <span class="s2">&quot;relationships. They have the following properties. Entities:&quot;</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e_props</span><span class="si">}</span><span class="s2">, Relationships: </span><span class="si">{</span><span class="n">r_props</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>        <span class="s2">&quot;Your task is to select the properties that are relevant to the &quot;</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>        <span class="s2">&quot;user&#39;s question for subsequent use in a query. Only return the &quot;</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>        <span class="s2">&quot;entities and relationships with their relevant properties in compact &quot;</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>        <span class="s2">&quot;JSON format, without any additional text. Return the &quot;</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>        <span class="s2">&quot;entities/relationships as top-level dictionary keys, and their &quot;</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>        <span class="s2">&quot;properties as dictionary values. &quot;</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>        <span class="s2">&quot;Do not return properties that are not relevant to the question.&quot;</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>    <span class="p">)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>    <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>    <span class="n">msg</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="n">BioCypherPromptEngine</span><span class="o">.</span><span class="n">_validate_json_str</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="p">{}</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine._select_relationships" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">_select_relationships</span><span class="p">(</span><span class="n">conversation</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Given a question and the preselected entities, select relationships for
the query.</p>
        <hr />
<div class="highlight"><pre><span></span><code>conversation: A BioChatter Conversation object for connecting to the
    LLM.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>True if at least one relationship was selected, False otherwise.
</code></pre></div>
<h5 id="biochatter.prompts.BioCypherPromptEngine._select_relationships--todo">Todo:</h5>
<div class="highlight"><pre><span></span><code>Now we have the problem that we discard all relationships that do
not have a source and target, if at least one relationship has a
source and target. At least communicate this all-or-nothing
behaviour to the user.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="k">def</span><span class="w"> </span><span class="nf">_select_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conversation</span><span class="p">:</span> <span class="s2">&quot;Conversation&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a question and the preselected entities, select relationships for</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a><span class="sd">    the query.</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    ----</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        conversation: A BioChatter Conversation object for connecting to the</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">            LLM.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">    -------</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">        True if at least one relationship was selected, False otherwise.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">    Todo:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">    ----</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">        Now we have the problem that we discard all relationships that do</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">        not have a source and target, if at least one relationship has a</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="sd">        source and target. At least communicate this all-or-nothing</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">        behaviour to the user.</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>            <span class="s2">&quot;No question found. Please make sure to run entity selection first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="s2">&quot;No entities found. Please run the entity selection step first.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="n">rels</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="n">source_and_target_present</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="c1"># if source or target is a list, expand to single pairs</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="n">source</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                    <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                        <span class="p">(</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                            <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                            <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                        <span class="p">),</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                    <span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">rels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairs</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="n">source_and_target_present</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="n">rels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>    <span class="c1"># prioritise relationships that have source and target, and discard</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>    <span class="c1"># relationships that do not have both source and target, if at least one</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>    <span class="c1"># relationship has both source and target. keep relationships that have</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="c1"># either source or target, if none of the relationships have both source</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="c1"># and target.</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="k">if</span> <span class="n">source_and_target_present</span><span class="p">:</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="c1"># First, separate the relationships into two groups: those with both</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="c1"># source and target in the selected entities, and those with either</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="c1"># source or target but not both.</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">rels_with_both</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">rels_with_either</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                    <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                        <span class="n">rels_with_both</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                        <span class="n">rels_with_either</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="k">elif</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                    <span class="n">rels_with_either</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="c1"># If there are any relationships with both source and target,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="c1"># discard the others.</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="k">if</span> <span class="n">rels_with_both</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="n">rels</span> <span class="o">=</span> <span class="n">rels_with_both</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="n">rels</span> <span class="o">=</span> <span class="n">rels_with_either</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="n">selected_rels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">rels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="k">continue</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span> <span class="ow">or</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                    <span class="n">selected_rels</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">pair</span><span class="p">))</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">rels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">selected_rels</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="n">rels</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">)</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="s2">&quot;You have access to a knowledge graph that contains &quot;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="sa">f</span><span class="s2">&quot;these entities: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="s2">&quot;Your task is to select the relationships that are relevant &quot;</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="s2">&quot;to the user&#39;s question for subsequent use in a query. Only &quot;</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="s2">&quot;return the relationships without their sources or targets, &quot;</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="s2">&quot;comma-separated, and without any additional text. Here are the &quot;</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="s2">&quot;possible relationships and their source and target entities: &quot;</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rels</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="n">conversation</span><span class="o">.</span><span class="n">append_system_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="n">res</span><span class="p">,</span> <span class="n">token_usage</span><span class="p">,</span> <span class="n">correction</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="k">for</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="n">relationship</span> <span class="o">=</span> <span class="n">relationship</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="k">if</span> <span class="n">relationship</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationships</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relationship</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>                <span class="n">rel_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relationships</span><span class="p">[</span><span class="n">relationship</span><span class="p">]</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>                <span class="n">label</span> <span class="o">=</span> <span class="n">rel_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label_as_edge&quot;</span><span class="p">,</span> <span class="n">relationship</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">rel_dict</span> <span class="ow">and</span> <span class="s2">&quot;target&quot;</span> <span class="ow">in</span> <span class="n">rel_dict</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>                        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">rel_dict</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="n">rel_dict</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">],</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>                    <span class="p">}</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>                        <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>                        <span class="s2">&quot;target&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>                    <span class="p">}</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="c1"># if we selected relationships that have either source or target which</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>    <span class="c1"># is not in the selected entities, we add those entities to the selected</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="c1"># entities.</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">:</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="n">sources</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">ensure_iterable</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>                <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>                        <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">source</span><span class="p">),</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                    <span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">:</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                        <span class="n">sentencecase_to_pascalcase</span><span class="p">(</span><span class="n">target</span><span class="p">),</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                    <span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine.generate_query" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_query</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">query_language</span><span class="o">=</span><span class="s1">&#39;Cypher&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Wrap entity and property selection and query generation; return the
generated query.</p>
        <hr />
<div class="highlight"><pre><span></span><code>question: A user&#39;s question.

query_language: The language of the query to generate.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>A database query that could answer the user&#39;s question.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_query</span><span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Cypher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap entity and property selection and query generation; return the</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    generated query.</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">    ----</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">        question: A user&#39;s question.</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">        query_language: The language of the query to generate.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    -------</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        A database query that could answer the user&#39;s question.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_select_graph_entities_from_question</span><span class="p">(</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">(),</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query</span><span class="p">(</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">entities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">,</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">relationships</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">properties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">query_language</span><span class="o">=</span><span class="n">query_language</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">conversation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">(),</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.prompts.BioCypherPromptEngine.generate_query_prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_query_prompt</span><span class="p">(</span><span class="n">question</span><span class="p">,</span> <span class="n">query_language</span><span class="o">=</span><span class="s1">&#39;Cypher&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a prompt for a large language model to generate a database
query based on the user's question and class attributes informing about
the schema.</p>
        <hr />
<div class="highlight"><pre><span></span><code>question: A user&#39;s question.

query_language: The language of the query to generate.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>A prompt for a large language model to generate a database query.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/prompts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">query_language</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="s2">&quot;Cypher&quot;</span><span class="p">,</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a prompt for a large language model to generate a database</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="sd">    query based on the user&#39;s question and class attributes informing about</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    the schema.</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">    ----</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        question: A user&#39;s question.</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        query_language: The language of the query to generate.</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">    -------</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        A prompt for a large language model to generate a database query.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_select_graph_entities_from_question</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="n">question</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">(),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query_prompt</span><span class="p">(</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_entities</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_relationship_labels</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">selected_properties</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">query_language</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="p">)</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">return</span> <span class="n">msg</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="execution-of-prompts-against-the-database">Execution of prompts against the database</h2>


<div class="doc doc-object doc-module">



<a id="biochatter.database_agent"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="biochatter.database_agent.DatabaseAgent" class="doc doc-heading">
            <code>DatabaseAgent</code>


</h2>


    <div class="doc doc-contents ">







              <details class="quote">
                <summary>Source code in <code>biochatter/biochatter/database_agent.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">DatabaseAgent</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">connection_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>        <span class="n">schema_config_or_info_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="n">conversation_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">use_reflexion</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a DatabaseAgent analogous to the VectorDatabaseAgentMilvus class,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        which can return results from a database using a query engine. Currently</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        limited to Neo4j for development.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        ----</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">            connection_args (dict): A dictionary of arguments to connect to the</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">                database. Contains database name, URI, user, and password.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            conversation_factory (Callable): A function to create a conversation</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">                for creating the KG query.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            use_reflexion (bool): Whether to use the ReflexionAgent to generate</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">                the query.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span> <span class="o">=</span> <span class="n">conversation_factory</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">BioCypherPromptEngine</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">schema_config_or_info_dict</span><span class="o">=</span><span class="n">schema_config_or_info_dict</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>            <span class="n">conversation_factory</span><span class="o">=</span><span class="n">conversation_factory</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span> <span class="o">=</span> <span class="n">connection_args</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">use_reflexion</span> <span class="o">=</span> <span class="n">use_reflexion</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to the database and authenticate.&quot;&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">db_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db_name&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span> <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bolt://&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;bolt://&quot;</span> <span class="o">+</span> <span class="n">uri</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">Driver</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="n">db_name</span><span class="o">=</span><span class="n">db_name</span> <span class="ow">or</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="n">db_uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_reflexion</span><span class="p">:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="n">agent</span> <span class="o">=</span> <span class="n">KGQueryReflexionAgent</span><span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">query_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span><span class="o">.</span><span class="n">generate_query_prompt</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">agent_result</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">query_prompt</span><span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">tool_result</span> <span class="o">=</span> <span class="p">[</span><span class="n">agent_result</span><span class="o">.</span><span class="n">tool_result</span><span class="p">]</span> <span class="k">if</span> <span class="n">agent_result</span><span class="o">.</span><span class="n">tool_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="k">return</span> <span class="n">agent_result</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span> <span class="n">tool_result</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span><span class="o">.</span><span class="n">generate_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="k">return</span> <span class="n">query</span><span class="p">,</span> <span class="n">results</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_build_response</span><span class="p">(</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">cypher_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">results_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="n">Document</span><span class="p">(</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                    <span class="n">page_content</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                        <span class="s2">&quot;I didn&#39;t find any result in knowledge graph, &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                        <span class="sa">f</span><span class="s2">&quot;but here is the query I used: </span><span class="si">{</span><span class="n">cypher_query</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                        <span class="s2">&quot;You can ask user to refine the question. &quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                        <span class="s2">&quot;Note: please ensure to include the query in a code &quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                        <span class="s2">&quot;block in your response so that the user can refine &quot;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                        <span class="s2">&quot;their question effectively.&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                    <span class="p">),</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cypher_query&quot;</span><span class="p">:</span> <span class="n">cypher_query</span><span class="p">},</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="p">),</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="p">]</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">clipped_results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:</span><span class="n">results_num</span><span class="p">]</span> <span class="k">if</span> <span class="n">results_num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">results</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">results_dump</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">clipped_results</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="n">Document</span><span class="p">(</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="n">page_content</span><span class="o">=</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                    <span class="s2">&quot;The results retrieved from knowledge graph are: &quot;</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results_dump</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                    <span class="sa">f</span><span class="s2">&quot;The query used is: </span><span class="si">{</span><span class="n">cypher_query</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                    <span class="s2">&quot;Note: please ensure to include the query in a code block &quot;</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="s2">&quot;in your response so that the user can refine &quot;</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="s2">&quot;their question effectively.&quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="p">),</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cypher_query&quot;</span><span class="p">:</span> <span class="n">cypher_query</span><span class="p">},</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="p">),</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="p">]</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a query using the prompt engine and return the results.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">        Replicates vector database similarity search API. Results are returned</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">        as a list of Document objects to align with the vector database agent.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        ----</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">            query (str): A query string.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">            k (int): The number of results to return.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        -------</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">            List[Document]: A list of Document objects. The page content values</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">                are the literal dictionaries returned by the query, the metadata</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">                values are the cypher query used to generate the results, for</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">                now.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="p">(</span><span class="n">cypher_query</span><span class="p">,</span> <span class="n">tool_result</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="p">)</span>  <span class="c1"># self.prompt_engine.generate_query(query)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="c1"># TODO some logic if it fails?</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">if</span> <span class="n">tool_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="c1"># If _generate_query() already returned tool_result, we won&#39;t connect</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="c1"># to graph database to query result any more</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">tool_result</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">cypher_query</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="c1"># return first k results</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="c1"># returned nodes can have any formatting, and can also be empty or fewer</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="c1"># than k</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_response</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">cypher_query</span><span class="o">=</span><span class="n">cypher_query</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">results_num</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;MATCH (n:Schema_info) RETURN n LIMIT 1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="n">schema_info_node</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="n">schema_dict_content</span> <span class="o">=</span> <span class="n">schema_info_node</span><span class="p">[</span><span class="s2">&quot;schema_info&quot;</span><span class="p">][:</span><span class="n">MAX_AGENT_DESC_LENGTH</span><span class="p">]</span>  <span class="c1"># limit to 1000 characters</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;the graph database contains the following nodes and edges: </span><span class="se">\n\n</span><span class="si">{</span><span class="n">schema_dict_content</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="c1"># schema_info is not found in database</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="n">nodes_query</span> <span class="o">=</span> <span class="s2">&quot;MATCH (n) RETURN DISTINCT labels(n) LIMIT 300&quot;</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">node_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">nodes_query</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">edges_query</span> <span class="o">=</span> <span class="s2">&quot;MATCH (n) RETURN DISTINCT type(n) LIMIT 300&quot;</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="n">edge_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">edges_query</span><span class="p">)</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="sa">f</span><span class="s2">&quot;The graph database contains the following nodes and edges: </span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="sa">f</span><span class="s2">&quot;nodes: </span><span class="se">\n</span><span class="si">{</span><span class="n">node_results</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="sa">f</span><span class="s2">&quot;edges: </span><span class="se">\n</span><span class="si">{</span><span class="n">edge_results</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">return</span> <span class="n">desc</span><span class="p">[:</span><span class="n">MAX_AGENT_DESC_LENGTH</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="biochatter.database_agent.DatabaseAgent.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">connection_args</span><span class="p">,</span> <span class="n">schema_config_or_info_dict</span><span class="p">,</span> <span class="n">conversation_factory</span><span class="p">,</span> <span class="n">use_reflexion</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Create a DatabaseAgent analogous to the VectorDatabaseAgentMilvus class,
which can return results from a database using a query engine. Currently
limited to Neo4j for development.</p>
        <hr />
<div class="highlight"><pre><span></span><code>connection_args (dict): A dictionary of arguments to connect to the
    database. Contains database name, URI, user, and password.

conversation_factory (Callable): A function to create a conversation
    for creating the KG query.

use_reflexion (bool): Whether to use the ReflexionAgent to generate
    the query.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/database_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>    <span class="n">connection_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">schema_config_or_info_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">conversation_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="n">use_reflexion</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a DatabaseAgent analogous to the VectorDatabaseAgentMilvus class,</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    which can return results from a database using a query engine. Currently</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    limited to Neo4j for development.</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    ----</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        connection_args (dict): A dictionary of arguments to connect to the</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            database. Contains database name, URI, user, and password.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        conversation_factory (Callable): A function to create a conversation</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            for creating the KG query.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        use_reflexion (bool): Whether to use the ReflexionAgent to generate</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            the query.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">conversation_factory</span> <span class="o">=</span> <span class="n">conversation_factory</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">prompt_engine</span> <span class="o">=</span> <span class="n">BioCypherPromptEngine</span><span class="p">(</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">schema_config_or_info_dict</span><span class="o">=</span><span class="n">schema_config_or_info_dict</span><span class="p">,</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">conversation_factory</span><span class="o">=</span><span class="n">conversation_factory</span><span class="p">,</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span> <span class="o">=</span> <span class="n">connection_args</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">use_reflexion</span> <span class="o">=</span> <span class="n">use_reflexion</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.database_agent.DatabaseAgent.connect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Connect to the database and authenticate.</p>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/database_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Connect to the database and authenticate.&quot;&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="n">db_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;db_name&quot;</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="n">uri</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span> <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;bolt://&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;bolt://&quot;</span> <span class="o">+</span> <span class="n">uri</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">nu</span><span class="o">.</span><span class="n">Driver</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">db_name</span><span class="o">=</span><span class="n">db_name</span> <span class="ow">or</span> <span class="s2">&quot;neo4j&quot;</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="n">db_uri</span><span class="o">=</span><span class="n">uri</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="biochatter.database_agent.DatabaseAgent.get_query_results" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_query_results</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate a query using the prompt engine and return the results.
Replicates vector database similarity search API. Results are returned
as a list of Document objects to align with the vector database agent.</p>
        <hr />
<div class="highlight"><pre><span></span><code>query (str): A query string.

k (int): The number of results to return.
</code></pre></div>
        <hr />
<div class="highlight"><pre><span></span><code>List[Document]: A list of Document objects. The page content values
    are the literal dictionaries returned by the query, the metadata
    values are the cypher query used to generate the results, for
    now.
</code></pre></div>

            <details class="quote">
              <summary>Source code in <code>biochatter/biochatter/database_agent.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a query using the prompt engine and return the results.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><span class="sd">    Replicates vector database similarity search API. Results are returned</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    as a list of Document objects to align with the vector database agent.</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">    ----</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">        query (str): A query string.</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">        k (int): The number of results to return.</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">    -------</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        List[Document]: A list of Document objects. The page content values</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">            are the literal dictionaries returned by the query, the metadata</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">            values are the cypher query used to generate the results, for</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">            now.</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="p">(</span><span class="n">cypher_query</span><span class="p">,</span> <span class="n">tool_result</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_query</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">query</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>    <span class="p">)</span>  <span class="c1"># self.prompt_engine.generate_query(query)</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="c1"># TODO some logic if it fails?</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>    <span class="k">if</span> <span class="n">tool_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="c1"># If _generate_query() already returned tool_result, we won&#39;t connect</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="c1"># to graph database to query result any more</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">tool_result</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="n">cypher_query</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="c1"># return first k results</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="c1"># returned nodes can have any formatting, and can also be empty or fewer</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="c1"># than k</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_response</span><span class="p">(</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">cypher_query</span><span class="o">=</span><span class="n">cypher_query</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">results_num</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../vectorstore/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Vectorstore Agent">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Vectorstore Agent
              </div>
            </div>
          </a>
        
        
          
          <a href="../api-calling-base/" class="md-footer__link md-footer__link--next" aria-label="Next: API Calling: Base Classes">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                API Calling: Base Classes
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
       Copyright 2021-2025, BioCypher developers.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://biocypher.zulipchat.com/" target="_blank" rel="noopener" title="biocypher.zulipchat.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.767 3.589c0 1.209-.543 2.283-1.37 2.934l-8.034 7.174c-.149.128-.343-.078-.235-.25l2.946-5.9c.083-.165-.024-.368-.194-.368H4.452c-1.77 0-3.219-1.615-3.219-3.59C1.233 1.616 2.682 0 4.452 0h15.096c1.77-.001 3.219 1.614 3.219 3.589M4.452 24h15.096c1.77 0 3.219-1.616 3.219-3.59s-1.449-3.59-3.219-3.59H8.12c-.17 0-.277-.202-.194-.367l2.946-5.9c.108-.172-.086-.378-.235-.25l-8.033 7.173c-.828.65-1.37 1.725-1.37 2.934 0 1.974 1.448 3.59 3.218 3.59"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://saezlab.org/" target="_blank" rel="noopener" title="saezlab.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 0H4v2h16zM4 24h16v-2H4zM20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2m-8 2.75A2.25 2.25 0 0 1 14.25 9 2.25 2.25 0 0 1 12 11.25 2.25 2.25 0 0 1 9.75 9 2.25 2.25 0 0 1 12 6.75M17 17H7v-1.5c0-1.67 3.33-2.5 5-2.5s5 .83 5 2.5z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://slolab.ai/" target="_blank" rel="noopener" title="slolab.ai" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.sections", "search.suggest", "search.highlight", "content.code.copy", "navigation.footer", "content.action.edit", "search.suggest", "search.highlight", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../../scripts/tablesort.js"></script>
      
    
  </body>
</html>